<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mecze Blanki</title>
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://accounts.google.com https://cdnjs.cloudflare.com 'unsafe-inline';
        style-src 'self' https://accounts.google.com https://cdnjs.cloudflare.com 'unsafe-inline';
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
        img-src 'self' data: https:;
        connect-src 'self' https://www.googleapis.com;
        frame-src https://accounts.google.com;
    ">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

    .google-auth-container {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }
    
    #user-info {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #f8f9fa;
        padding: 8px 15px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: none;
    }
    
    #logout-btn {
        background-color: #dc3545;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
    }

    body {
        font-family: 'Roboto', sans-serif;
        background-color: #ffffff;
        color: #333;
        padding: 0;
        margin: 0;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }

    header {
        font-size: 28px;
        font-weight: bold;
        text-align: center;
        margin: 10px 0;
        color: #333;
        margin-top: 60px;
    }

    .calendar-container {
        width: 1200px;
        margin: 20px auto;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        border: 2px solid #0078d7;
        position: relative;
        padding-bottom: 80px;
    }

    .calendar-week {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }

    .calendar-day {
        flex: 1;
        text-align: center;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
        min-height: 150px;
        max-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        min-width: 120px;
        overflow-y: auto;
    }

    .calendar-day h3 {
        white-space: nowrap;
        font-size: 14px;
        margin: 0;
    }

    .calendar-day.past {
        background-color: #f8f9fa;
        opacity: 0.7;
    }

    .calendar-day.current {
        background-color: #e3f2fd;
        border: 2px solid #2196f3;
    }

    .event-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px;
        margin: 4px 0;
        background-color: #fff;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        height: 80px;
        cursor: pointer;
    }

    .event-icon {
        width: 32px;
        height: 32px;
        background-color: #eee;
        border-radius: 4px;
        flex-shrink: 0;
        background-size: cover;
    }

    .event-text {
        flex-grow: 1;
        text-align: left;
        font-size: 14px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        line-height: 1.2;
    }

    .event-text strong {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        margin-bottom: 2px;
    }

    .event-text small {
        font-size: 12px;
        margin-top: 2px;
    }

    .navigation-buttons {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 50px;
    }

    .btn-prev-calendar, .btn-next-calendar {
        background-color: #0078d7;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .btn-add-event {
        background-color: #28a745;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .btn-start-game {
        background-color: #dc3545;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .team-and-notes-container {
        display: flex;
        gap: 20px;
        width: 1200px;
        margin: 20px auto;
        position: relative;
    }

    .team-selection-container {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 20px;
        width: 600px;
        height: 320px;
        border: 2px solid #0078d7;
        border-radius: 8px;
        padding: 15px;
        background-color: #f8f9fa;
        position: relative;
    }

    .team-logo-container {
        flex-shrink: 0;
        display: flex;
        justify-content: left;
        align-items: center;
    }

    .team-logo {
        width: 300px;
        height: 300px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .team-info-container {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        position: relative;
        padding-bottom: 80px;
    }

    .team-selector, .date-input {
        width: 200px;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        margin-bottom: 10px;
    }

    .scouting-notes {
        width: 600px;
        height: 330px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        border: 2px solid #0078d7;
        border-radius: 8px;
        padding: 10px;
        background-color: #f8f9fa;
        position: relative;
    }

    .notes-display {
        padding: 10px;
        background-color: #fff;
        border-radius: 4px;
        margin-bottom: 10px;
        max-height: 200px;
        overflow-y: auto;
    }

    .notes-display p {
        margin: 5px 0;
        text-align: left;
        word-wrap: break-word;
        white-space: pre-wrap;
        font-size: 14px;
    }

    .notes-navigation {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
    }

    .btn-prev-note, .btn-next-note {
        background-color: #0078d7;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .btn-add-note {
        background-color: #28a745;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .btn-edit-note {
        background-color: #ffc107;
        color: black;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .stats-container {
        width: 1200px;
        margin: 20px auto;
        border: 2px solid #0078d7;
        border-radius: 8px;
        padding: 20px;
        background-color: #f9f9f9;
    }

    #matches-table {
        width: 100%;
        border-collapse: collapse;
    }

    #matches-table th, #matches-table td {
        padding: 8px;
        font-size: 14px;
        text-align: center;
        border: 1px solid #ddd;
        white-space: nowrap;
    }

    #matches-table th {
        background-color: #f2f2f2;
    }

    .btn-edit-stats {
        background-color: #ffc107;
        color: black;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .btn-delete-stats {
        background-color: #dc3545;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .btn-youtube {
        background-color: #ff0000;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .btn-prev-stats, .btn-next-stats {
        background-color: #0078d7;
        color: white;
        padding: 8px 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }

    .btn-prev-calendar:hover, .btn-prev-calendar:focus,
    .btn-add-event:hover, .btn-add-event:focus,
    .btn-next-calendar:hover, .btn-next-calendar:focus,
    .btn-start-game:hover, .btn-start-game:focus,
    .btn-prev-note:hover, .btn-prev-note:focus,
    .btn-add-note:hover, .btn-add-note:focus,
    .btn-edit-note:hover, .btn-edit-note:focus,
    .btn-next-note:hover, .btn-next-note:focus,
    .btn-edit-stats:hover, .btn-edit-stats:focus,
    .btn-delete-stats:hover, .btn-delete-stats:focus,
    .btn-youtube:hover, .btn-youtube:focus,
    .btn-prev-stats:hover, .btn-prev-stats:focus,
    .btn-next-stats:hover, .btn-next-stats:focus {
        opacity: 0.9;
        transform: scale(1.05);
        transition: all 0.3s ease;
    }

    @media screen and (max-width: 768px) {
        .team-and-notes-container {
            flex-direction: column;
        }

        .calendar-week {
            flex-direction: column;
        }

        .navigation-buttons, .notes-navigation {
            flex-direction: column;
            gap: 5px;
        }
    }
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="google-auth-container">
    <div id="user-info">
        Zalogowany jako: <span id="user-name"></span>
        <button id="logout-btn">Wyloguj</button>
    </div>
    <div id="g_id_onload"
         data-client_id="148953860327-72d408l9qvt34akmhaa1e37m4bvbto70.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div id="google-login-button" style="display: none;"></div>
</div>

    <header>
        <h2>Mój planner:</h2>
    </header>
    
    <div class="calendar-container">
        <div class="calendar-week"></div>
        <div class="navigation-buttons">
            <button class="btn-prev-calendar">Poprzednia</button>
            <button class="btn-add-event">+ Dodaj wydarzenie</button>
            <button class="btn-next-calendar">Następna</button>
        </div>
    </div>

    <header>
        <h2>Najbliższy przeciwnik:</h2>
    </header>

    <div class="team-and-notes-container">
        <div class="team-selection-container">
            <div class="team-logo-container">
                <img id="team-logo" src="BAT Sierakowice.png" alt="Logo drużyny" class="team-logo">
            </div>
            <div class="team-info-container">
                <select id="team-selector" class="team-selector">
                    <option value="BAT Sierakowice">BAT Sierakowice</option>
                    <option value="BAT Kartuzy">BAT Kartuzy</option>
                    <option value="Bryza Pruszcz Gd">Bryza Pruszcz Gd</option>
                    <option value="Elbląg">Elbląg</option>
                    <option value="Pruszcz Gdański 1">Pruszcz Gdański 1</option>
                    <option value="Pruszcz Gdański 2">Pruszcz Gdański 2</option>
                    <option value="BK VLCI Žďár">BK VLCI Žďár</option>
                    <option value="BKM Žilina">BKM Žilina</option>
                    <option value="MOSiR Bochnia">MOSiR Bochnia</option>
                    <option value="UKS ŻAK Nowy Sącz">UKS ŻAK Nowy Sącz</option>
                    <option value="Young Angels Košice">Young Angels Košice</option>
                </select>
                <input type="date" id="game-date" class="date-input">
                <button class="btn-start-game">Gramy</button>
            </div>
        </div>

        <div class="scouting-notes">
            <div class="notes-display" id="notes-display">
                <p>Tutaj dodaj swoje spostrzeżenia na temat przeciwnika. Kliknij "Dodaj".</p>
            </div>
            <div class="notes-navigation" id="notes-navigation">
                <button class="btn-prev-note">Poprzednia</button>
                <button class="btn-edit-note">Edytuj</button>
                <button class="btn-add-note">Dodaj</button>
                <button class="btn-next-note">Następna</button>
            </div>
        </div>
    </div>

    <header>
        <h2>Moje statystyki:</h2>
    </header>
    <div class="stats-container">
        <table id="matches-table">
            <thead>
                <tr>
                    <th>Drużyna</th>
                    <th>Data meczu</th>
                    <th>Punkty</th>
                    <th>Asysty</th>
                    <th>Bloki</th>
                    <th>Zbiórki</th>
                    <th>Przechwyty</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div id="pagination">
            <button id="prev-btn" class="btn-prev-stats" disabled>Poprzednia</button>
            <button id="next-btn" class="btn-next-stats" disabled>Następna</button>
        </div>
    </div>

    <footer>
        <a href="privacy.html" target="_blank">Polityka Prywatności</a> | 
        &copy; 2023 Mecze Blanki. Wszelkie prawa zastrzeżone.
    </footer>

    <script>
        const logos = {
            'BAT Sierakowice': 'BAT Sierakowice.png',
            'BAT Kartuzy': 'BAT Kartuzy.png',
            'Bryza Pruszcz Gd': 'Bryza Pruszcz Gd.png',
            'Elbląg': 'Elblag.png',
            'Pruszcz Gdański 1': 'Pruszcz Gdanski 1.png',
            'Pruszcz Gdański 2': 'Pruszcz Gdanski 2.png',
            'BK VLCI Žďár': 'BK VLCI Zdar.png',
            'BKM Žilina': 'BKM Zilina.png',
            'MOSiR Bochnia': 'MOSiR Bochnia.png',
            'UKS ŻAK Nowy Sącz': 'UKS ZAK Nowy Sacz.png',
            'Young Angels Košice': 'Young Angels Kosice.png'
        };

        let currentWeekStart = new Date();
        let notes = JSON.parse(localStorage.getItem('notes')) || {};
        let currentTeam = 'BAT Sierakowice';
        let currentNoteIndex = 0;
        let currentPage = 1;
        const recordsPerPage = 5;

        function decodeJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            return JSON.parse(atob(base64));
        }

        function checkLoginStatus() {
            const user = JSON.parse(localStorage.getItem('googleUser'));
            if (!user) return false;
            
            const tokenExpiration = user.exp * 1000;
            if (Date.now() > tokenExpiration) {
                localStorage.removeItem('googleUser');
                localStorage.removeItem('googleAccessToken');
                return false;
            }
            return true;
        }

        function handleCredentialResponse(response) {
            try {
                if (response.error) {
                    handleAuthError(response.error);
                    return;
                }
                
                const user = decodeJwt(response.credential);
                console.log("Zalogowany użytkownik:", user);
                
                localStorage.setItem('googleUser', JSON.stringify(user));
                updateUserUI(user);
                
                authorize().catch(error => {
                    console.error("Błąd autoryzacji:", error);
                    handleAuthError(error);
                });
            } catch (error) {
                console.error("Błąd przetwarzania odpowiedzi:", error);
                handleAuthError('unknown_error');
            }
        }
        
        function updateUserUI(user) {
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const loginButton = document.getElementById('google-login-button');
    
    if (user) {
        userName.textContent = user.name || user.email;
        userInfo.style.display = 'block';
        loginButton.style.display = 'none';
    } else {
        userInfo.style.display = 'none';
        loginButton.style.display = 'block';
        
        if (window.google && google.accounts.id) {
            google.accounts.id.renderButton(
                loginButton,
                { theme: "outline", size: "large" }
            );
        }
    }
}

        function handleAuthError(error) {
            console.error('Błąd autoryzacji:', error);
            let message = 'Wystąpił błąd podczas logowania.';
            
            if (error === 'access_denied') {
                message = 'Aby korzystać z tej funkcji, musisz być zatwierdzonym testerem. Skontaktuj się z administratorem aplikacji.';
            }
            
            alert(message);
        }

        function logout() {
            localStorage.removeItem('googleUser');
            localStorage.removeItem('googleAccessToken');
            updateUserUI(null);
        }

        async function authorize() {
            return new Promise((resolve, reject) => {
                if (!window.google || !google.accounts.oauth2) {
                    reject(new Error("Google API nie zostało załadowane"));
                    return;
                }

                const client = google.accounts.oauth2.initTokenClient({
                    client_id: '148953860327-72d408l9qvt34akmhaa1e37m4bvbto70.apps.googleusercontent.com',
                    scope: 'https://www.googleapis.com/auth/calendar.events',
                    prompt: 'consent',
                    callback: (response) => {
                        if (response.access_token) {
                            localStorage.setItem('googleAccessToken', response.access_token);
                            resolve(response.access_token);
                        } else {
                            const error = response.error || 'unknown_error';
                            handleAuthError(error);
                            reject(error);
                        }
                    },
                });
                client.requestAccessToken();
            });
        }

        function changeLogo() {
            const teamSelector = document.getElementById('team-selector');
            const logo = document.getElementById('team-logo');
            logo.src = logos[teamSelector.value] || 'BAT Sierakowice.png';
            currentTeam = teamSelector.value;
            localStorage.setItem('currentTeam', currentTeam);
            loadNotes();
            updateNotesNavigation();
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('game-date').value = today;
        }

        function startGame() {
            const team = document.getElementById('team-selector').value;
            const date = document.getElementById('game-date').value;

            if (!date) {
                alert("Proszę wybrać datę meczu!");
                return;
            }

            localStorage.setItem("selectedTeam", team);
            localStorage.setItem("selectedDate", date);
            localStorage.removeItem("editMatchId");
            window.location.href = "blania.html";
        }

        function openNotesForm() {
            localStorage.setItem('currentTeam', currentTeam);
            localStorage.removeItem('currentNoteIndex');
            window.location.href = 'notes-form.html';
        }

        function loadNotes() {
            const notesDisplay = document.getElementById('notes-display');
            const teamNotes = notes[currentTeam] || [];

            if (teamNotes.length === 0) {
                notesDisplay.innerHTML = '<p>Tutaj dodaj swoje spostrzeżenia na temat przeciwnika. Kliknij "Dodaj".</p>';
            } else {
                const note = teamNotes[currentNoteIndex];
                notesDisplay.innerHTML = `
                    <p><strong>Mocne strony:</strong> ${note.strengths}</p>
                    <p><strong>Słabe strony:</strong> ${note.weaknesses}</p>
                    <p><strong>Na co zwrócić uwagę:</strong> ${note.focus}</p>
                    <p><strong>Gwiazda:</strong> ${note.star}</p>
                    <p><strong>Kto mnie krył:</strong> ${note.defender}</p>
                    <p><strong>Inne:</strong> ${note.other}</p>
                    <p><strong>Ocena:</strong> ${'★'.repeat(note.rating)}</p>
                `;
            }
            updateNotesNavigation();
        }

        function updateNotesNavigation() {
            const teamNotes = notes[currentTeam] || [];
            const notesNavigation = document.getElementById('notes-navigation');
            const buttons = notesNavigation.querySelectorAll('button');
            
            buttons[0].style.display = teamNotes.length >= 2 ? 'inline-block' : 'none'; // Prev
            buttons[1].style.display = teamNotes.length > 0 ? 'inline-block' : 'none'; // Edit
            buttons[3].style.display = teamNotes.length >= 2 ? 'inline-block' : 'none'; // Next
        }

        function prevNote() {
            if (currentNoteIndex > 0) {
                currentNoteIndex--;
                loadNotes();
            }
        }

        function nextNote() {
            if (currentNoteIndex < notes[currentTeam].length - 1) {
                currentNoteIndex++;
                loadNotes();
            }
        }

        function editNote() {
            const teamNotes = notes[currentTeam] || [];
            if (teamNotes.length > 0) {
                const note = teamNotes[currentNoteIndex];
                localStorage.setItem('currentTeam', currentTeam);
                localStorage.setItem('currentNoteIndex', currentNoteIndex);
                localStorage.setItem('noteToEdit', JSON.stringify(note));
                window.location.href = 'notes-form.html';
            }
        }

        function moveCalendar(days) {
            if (days === 1) {
                currentWeekStart.setDate(currentWeekStart.getDate() + 5);
            } else if (days === -1) {
                currentWeekStart.setDate(currentWeekStart.getDate() - 5);
            }
            generateCalendar();
        }

        function generateCalendar() {
            const calendarWeek = document.querySelector('.calendar-week');
            calendarWeek.innerHTML = "";

            for (let i = 0; i < 5; i++) {
                const day = new Date(currentWeekStart);
                day.setDate(currentWeekStart.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                if (day < new Date()) dayElement.classList.add('past');
                if (day.toDateString() === new Date().toDateString()) dayElement.classList.add('current');

                const options = { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' };
                const formattedDate = new Intl.DateTimeFormat('pl-PL', options).format(day);
                const dayHeader = document.createElement('h3');
                dayHeader.textContent = formattedDate.replace('.', '');
                dayHeader.setAttribute('data-date', day.toISOString().split('T')[0]);
                dayElement.appendChild(dayHeader);

                const eventsList = document.createElement('div');
                eventsList.className = 'events-container';
                dayElement.appendChild(eventsList);

                const savedEvents = JSON.parse(localStorage.getItem('savedEvents')) || [];
                const hasEvents = savedEvents.some(event => new Date(event.date).toISOString().split('T')[0] === day.toISOString().split('T')[0]);

                if (!hasEvents) {
                    const noEventsText = document.createElement('p');
                    noEventsText.textContent = "Dziś regeneracja? Jeśli masz jakiś plan, kliknij '+ Dodaj wydarzenie'.";
                    noEventsText.style.fontStyle = 'italic';
                    noEventsText.style.color = '#666';
                    eventsList.appendChild(noEventsText);
                }
                calendarWeek.appendChild(dayElement);
            }
            loadEvents();
        }

        function loadEvents() {
            const savedEvents = JSON.parse(localStorage.getItem('savedEvents')) || [];
            const eventIcons = {
                'mecz-ligowy': 'match.png',
                'trening': 'training.png',
                'fizjoterapeuta': 'physio.png',
                'mecz-sparingowy': 'friendly.png',
                'turniej': 'tournament.png',
                'oboz': 'camp.png',
                'bus': 'bus.png'
            };

            savedEvents.forEach(event => {
                const eventDate = new Date(event.date).toISOString().split('T')[0];
                document.querySelectorAll('.calendar-day').forEach(dayElement => {
                    const dayDate = new Date(dayElement.querySelector('h3').getAttribute('data-date')).toISOString().split('T')[0];
                    if (dayDate === eventDate) {
                        const eventItem = document.createElement('div');
                        eventItem.className = 'event-item';
                        eventItem.setAttribute('data-event-id', event.id);

                        eventItem.addEventListener('click', () => editEvent(event.id));

                        const icon = document.createElement('div');
                        icon.className = 'event-icon';
                        icon.style.backgroundImage = `url(${eventIcons[event.type]})`;
                        icon.style.backgroundSize = 'cover';
                        eventItem.appendChild(icon);

                        const text = document.createElement('div');
                        text.className = 'event-text';
                        text.innerHTML = `
                            <strong>${event.date.split('T')[1].substring(0, 5)} ${event.name.substring(0, 20)}${event.name.length > 20 ? '...' : ''}</strong><br>
                            ${event.name.length > 20 ? `<small>${event.name.substring(20)}</small>` : ''}
                            <small>${event.location}</small>
                        `;
                        eventItem.appendChild(text);

                        dayElement.querySelector('.events-container').appendChild(eventItem);
                    }
                });
            });
        }

        function editEvent(eventId) {
            const savedEvents = JSON.parse(localStorage.getItem('savedEvents')) || [];
            const eventToEdit = savedEvents.find(event => event.id === eventId);

            if (eventToEdit) {
                localStorage.setItem("selectedDate", eventToEdit.date.split('T')[0]);
                localStorage.setItem("editEventId", eventToEdit.id);
                window.location.href = "add-event.html";
            } else {
                alert("Event nie został znaleziony.");
            }
        }

        function loadSavedMatches() {
            const tableBody = document.querySelector("#matches-table tbody");
            let savedMatches = JSON.parse(localStorage.getItem("savedMatches")) || [];

            savedMatches.sort((a, b) => new Date(b.date) - new Date(a.date));

            const start = (currentPage - 1) * recordsPerPage;
            const end = start + recordsPerPage;
            const paginatedMatches = savedMatches.slice(start, end);

            tableBody.innerHTML = "";
            paginatedMatches.forEach((match) => {
                const row = document.createElement("tr");
                ["team", "date", "total", "Asy", "Blok", "Zb", "Prze"].forEach(stat => {
                    const cell = document.createElement("td");
                    cell.textContent = match[stat] || 0;
                    row.appendChild(cell);
                });

                const actionCell = document.createElement("td");
                const actionContainer = document.createElement("div");
                actionContainer.className = "action-container";

                const editButton = document.createElement("button");
                editButton.innerHTML = '<img src="edit.png" alt="Edytuj" class="action-icon">';
                editButton.className = "action-btn edit-btn";
                editButton.addEventListener('click', () => editMatch(match.id));
                actionContainer.appendChild(editButton);

                const deleteButton = document.createElement("button");
                deleteButton.innerHTML = '<img src="trash.png" alt="Usuń" class="action-icon">';
                deleteButton.className = "action-btn delete-btn";
                deleteButton.addEventListener('click', () => {
                    if (confirm("Czy na pewno chcesz usunąć ten mecz?")) {
                        savedMatches = savedMatches.filter(m => m.id !== match.id);
                        localStorage.setItem("savedMatches", JSON.stringify(savedMatches));
                        loadSavedMatches();
                    }
                });
                actionContainer.appendChild(deleteButton);

                if (match.streamLink?.trim()) {
                    const youtubeButton = document.createElement("button");
                    youtubeButton.innerHTML = '<img src="youtube.png" alt="YouTube" class="action-icon">';
                    youtubeButton.className = "action-btn yt-btn";
                    youtubeButton.addEventListener('click', () => window.open(match.streamLink, "_blank"));
                    actionContainer.appendChild(youtubeButton);
                }

                actionCell.appendChild(actionContainer);
                row.appendChild(actionCell);
                tableBody.appendChild(row);
            });

            document.getElementById("pagination").style.display = savedMatches.length > recordsPerPage ? 'flex' : 'none';
            document.getElementById("prev-btn").disabled = currentPage === 1;
            document.getElementById("next-btn").disabled = currentPage * recordsPerPage >= savedMatches.length;
        }

        function changePage(direction) {
            currentPage += direction;
            loadSavedMatches();
        }

        function addEvent() {
            if (!checkLoginStatus()) {
                alert("Proszę zalogować się przez Google przed dodaniem wydarzenia");
                return;
            }
            
            const selectedDate = new Date(currentWeekStart).toISOString().split('T')[0];
            localStorage.setItem("selectedDate", selectedDate);
            window.location.href = "add-event.html";
        }

        async function addEventToGoogleCalendar(event) {
            try {
                if (!checkLoginStatus()) {
                    throw new Error("Proszę zalogować się przez Google");
                }

                let accessToken = localStorage.getItem('googleAccessToken');
                if (!accessToken) {
                    accessToken = await authorize();
                }

                const startDate = new Date(event.date);
                if (isNaN(startDate.getTime())) {
                    throw new Error("Nieprawidłowy format daty");
                }

                const endDate = new Date(startDate.getTime() + (event.duration || 60) * 60 * 1000);

                const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        summary: event.name,
                        location: event.location || '',
                        description: event.notes || '',
                        start: { dateTime: startDate.toISOString(), timeZone: 'Europe/Warsaw' },
                        end: { dateTime: endDate.toISOString(), timeZone: 'Europe/Warsaw' },
                        reminders: { useDefault: false, overrides: [{ method: 'popup', minutes: event.reminder || 30 }] }
                    }),
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('googleAccessToken');
                        return addEventToGoogleCalendar(event);
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "Błąd podczas dodawania wydarzenia");
                }

                return await response.json();
            } catch (error) {
                console.error("Błąd:", error);
                throw error;
            }
        }

        // Inicjalizacja strony
        window.addEventListener('load', () => {
            setTodayDate();

            const user = JSON.parse(localStorage.getItem('googleUser'));
            updateUserUI(user);

            const savedTeam = localStorage.getItem('currentTeam');
            if (savedTeam) {
                currentTeam = savedTeam;
                document.getElementById('team-selector').value = currentTeam;
                changeLogo();
            } else {
                changeLogo();
            }

            generateCalendar();
            loadSavedMatches();
            loadNotes();

            // Poprawione nasłuchiwanie zdarzeń
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('team-selector').addEventListener('change', changeLogo);
            document.querySelector('.btn-prev-calendar').addEventListener('click', () => moveCalendar(-1));
            document.querySelector('.btn-next-calendar').addEventListener('click', () => moveCalendar(1));
            document.querySelector('.btn-add-event').addEventListener('click', addEvent);
            document.querySelector('.btn-start-game').addEventListener('click', startGame);
            document.querySelector('.btn-prev-note').addEventListener('click', prevNote);
            document.querySelector('.btn-next-note').addEventListener('click', nextNote);
            document.querySelector('.btn-add-note').addEventListener('click', openNotesForm);
            document.querySelector('.btn-edit-note').addEventListener('click', editNote);
            document.getElementById('prev-btn').addEventListener('click', () => changePage(-1));
            document.getElementById('next-btn').addEventListener('click', () => changePage(1));
        });
    </script>
</body>
</html>
